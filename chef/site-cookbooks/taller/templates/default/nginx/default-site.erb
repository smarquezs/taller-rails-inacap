server {
    listen 80 default deferred;

    rails_env <%= node['app']['env'] %>;
    passenger_enabled on;
    
    access_log  <%= node['nginx']['log_dir'] %>/<%= node['app']['name'] %>.access.log;

    root <%= node['app']['dir'] %>/public;

    if  ($host ~* '^archdaily.com.br(.*)'){
        rewrite (.*)  http://www.archdaily.com.br$1 permanent;
        break;
    }

    if  ($host ~* '^archdaily.cn(.*)'){
        rewrite (.*)  http://www.archdaily.cn$1 permanent;
        break;
    }

    if ($host = 'www.archdaily.cn'){
        # robots.txt
        rewrite /robots.txt$ http://www.archdaily.cn/robots/cn.txt;

        # feeds
        rewrite /feed/$ http://feeds.feedburner.com/ArchdailyCN permanent;
        rewrite /cn/feed$ http://feeds.feedburner.com/ArchdailyCN permanent;
        rewrite ^(.*).rss$ http://feeds.feedburner.com/ArchdailyCN permanent;
    }

    if ($host = 'www.archdaily.com.br'){
        # robots.txt
        rewrite /robots.txt$ http://www.archdaily.com.br/robots/br.txt;

        # feeds
        rewrite /feed$ http://feeds.feedburner.com/ArchdailyBR permanent;
        rewrite /br/feed$ http://feeds.feedburner.com/ArchdailyBR permanent;
        rewrite ^(.*).rss$ http://feeds.feedburner.com/ArchdailyBR permanent;

        # sitemaps
        rewrite /sitemap_index.xml.gz$ http://nimrod-cdn.archdaily.net/robots/br/sitemap_index.xml.gz;
    }

    location ^~ /assets/ {
        gzip_static on;
        expires max;
        add_header Cache-Control public;
    }

    location /auth/ {
        resolver 8.8.8.8;
        proxy_pass http://kenneth.dyn.archdaily.com;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /catalog {
        resolver 8.8.8.8;
        add_header Access-Control-Allow-Origin *;
        proxy_pass http://neufert.dyn.archdaily.com;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /produtos {
        resolver 8.8.8.8;
        proxy_pass http://elb.legacy.archdaily.com.br/produtos;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Authorization "Basic YWQ6YWRwYXNz";
    }

    location /empresas {
        resolver 8.8.8.8;
        proxy_pass http://elb.legacy.archdaily.com.br/empresas;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Authorization "Basic YWQ6YWRwYXNz";
    }

    location /wp-content {
        resolver 8.8.8.8;
        proxy_pass http://elb.legacy.archdaily.com.br/wp-content;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Authorization "Basic YWQ6YWRwYXNz";
    }

    location /wp-includes {
        resolver 8.8.8.8;
        proxy_pass http://elb.legacy.archdaily.com.br/wp-includes;
        #proxy_redirect   http://adbr-stac-elasticl-855ggdxjew4x-498797775.sa-east-1.elb.amazonaws.com/  /wp-includes$1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Authorization "Basic YWQ6YWRwYXNz";
    }

    location ~* /catalog/assets/\.(eot|otf|ttf|woff)$ {
        add_header Access-Control-Allow-Origin *;
    }

    error_page 500 502 503 504 /500.html;
    client_max_body_size 4G;
    keepalive_timeout 10;
}

server {
    listen       80;
    server_name  ~^img(\d+)\.adsttc\.com$;
    charset us-ascii;

    location ~ (/favicon.ico) {
      resolver 8.8.8.8;
      proxy_pass http://www.archdaily.com$1;
      break;
    }

    location ~ (.*) {
      resolver 8.8.8.8;
      proxy_pass http://newsroom001.s3.amazonaws.com;
      proxy_pass_request_body off;
      proxy_set_header Content-Length 0;
      break;
    }
}
